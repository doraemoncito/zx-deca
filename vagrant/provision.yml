---
- hosts: all
  become: yes
  user: vagrant
  vars:
    - vagrant_home: /home/vagrant
    - quartus_file_name: Quartus-lite-20.1.1.720-linux.tar
    - quartus_directory: /home/vagrant/zx-deca/quartus
  tasks:

    - name: "Updating installed packages"
      apt:
        name: '*'
        update_cache: yes
        state: latest
        force_apt_get: True

    - name: "Install the desktop environment and development tools"
      apt:
        name:
          # ntpdate is need to update the time on the vagrant built machine when if falls
          # out of sync with the host. e.g. `sudo ntpdate time.nist.gov`
          - ntpdate
          # Miscellaneous development tools
          - git
          - minicom
          - emacs
          - tree
          # Desktop environment
          - ubuntu-desktop
          - virtualbox-guest-dkms
          - virtualbox-guest-utils
          - virtualbox-guest-x11
          - firefox
        state: latest
        force_apt_get: True

    - name: "Add the vagrant user to the dialout group so that it can access the Maker pHat serial device /dev/ttyUSB0"
      user:
        name: vagrant
        groups:
          - dialout
          - tty
        append: yes

    - name: "Enable automatic logins"
      template:
        src: templates/custom.conf
        dest: /etc/gdm3/custom.conf
        owner: root
        group: root
        mode: u=rw,g=r,o=r

    - name: "Configure access to the USB Blaster device for all users"
      template:
        src: templates/51-usbblaster.rules
        dest: /etc/udev/rules.d/51-usbblaster.rules
        owner: root
        group: root
        mode: u=rw,g=r,o=r

    # [Tweaks for Vagrant boxes to prevent locking in the VM](https://gist.github.com/dragon788/a748d02ac5cec9fa8bc7)
    - name: "Configure V< to prevent screen locking"
      shell: |
        # Disable screensaver (by setting time to never)
        gsettings set org.gnome.desktop.session idle-delay 0
        # Disable lock screen entirely
        gsettings set org.gnome.desktop.lockdown disable-lock-screen true

    - name: "Copy theQuartus installtion script to the guest machine"
      template:
        src: templates/install_quartus.sh
        dest: "{{vagrant_home}}/install_quartus.sh"
        owner: vagrant
        group: vagrant
        mode: u=rx,g=r,o=r

    - name: "Extract Quartus"
      unarchive:
        src: "{{quartus_directory}}/{{quartus_file_name}}"
        dest: "{{quartus_directory}}"
        creates: "{{quartus_directory}}/components"

    # NOTE: When installing via Ansible, the Quartus installed seems unable to detect the fact that we have a complete
    # desktop environment and omits the installation of the desktop shortcut (and possibly other things) so we'll have
    # to ask the user to install Quartus from the console.
    #
    # - name: "Install Quartus"
    #   shell: ./setup.sh --unattendedmodeui none --mode unattended --accept_eula 1
    #   become_user: vagrant
    #   args:
    #     chdir: "{{quartus_directory}}/"
    #     creates: "{{vagrant_home}}/Desktop/Quartus*.desktop"

    - name: "Reboot the machine"
      shell: "sleep 5 && reboot"
      async: 1
      poll: 0

